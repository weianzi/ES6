<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hello, World</title>
    <style type="text/css">
    html {
        height: 100%
    }
    
    body {
        height: 100%;
        margin: 0px;
        padding: 0px
    }
    
    #container {
        height: 100%;
        margin: 20px;
    }
    </style>
    <script src="http://api.map.baidu.com/api?v=2.0&ak=srpbYTidksiwvfrsfXa8IHfk"></script>
</head>

<body>
    <div id="container"></div>
    <script type="text/javascript">
    // 实时轨迹demo。
    // 实际运用的话可能ajax实时读取后台数据，加载到地图上。


    // 获取随机数
    function getRandom(n) {
        return Math.floor(Math.random() * n + 1)
    }
    //找到每一次运动，需要偏移的角度
    function findRotation(startPoint, endPoint) {
        var x = endPoint.lng - startPoint.lng; //lng-经度，lat-纬度
        var y = endPoint.lat - startPoint.lat;
        if (x == 0) {
            return 0;
        }
        if (x > 0) {
            var z = Math.sqrt(x * x + y * y);
            var angle = Math.round((Math.asin(y / z) / Math.PI * 180)); //最终角度
            if (angle >= 0) {
                return 90 - angle;
            } else {
                return 90 + Math.abs(angle);
            }
        }
        if (x < 0) {
            var z = Math.sqrt(x * x + y * y);
            var angle = Math.round((Math.asin(y / z) / Math.PI * 180)); //最终角度
            if (angle >= 0) {
                return 270 + angle;
            } else {
                return 270 - Math.abs(angle);
            }
        }

    }
    //在轨迹点上创建图标，并添加点击事件，显示轨迹点信息。points,数组。
    function addMarker(points, angle) {
        var pointsLen = points.length;
        if (pointsLen == 0) {
            return;
        }
        // var myIcon = new BMap.Icon("track.ico", new BMap.Size(20, 20), {
        //     offset: new BMap.Size(20, 20)
        // });
        var myIcon = new BMap.Icon("fly.ico", new BMap.Size(16, 16), {
            offset: new BMap.Size(16, 16), // 指定定位位置
            //imageOffset: new BMap.Size(0, 0) // 设置图片偏移
        });
        // 创建标注对象并添加到地图   
        for (var i = 0; i < pointsLen; i++) {
            var point = new BMap.Point(points[i].lng, points[i].lat);
            var marker = new BMap.Marker(point, {
                icon: myIcon
            });
            //var label=new BMap.Label("test");
            //marker.setLabel(label);  
            console.log(angle);  
            marker.setRotation(angle);//设置旋转角度
            map.addOverlay(marker);
        }
    }

    //添加线
    function addLine(points) {
        //console.log(points);
        var linePoints = [],
            pointsLen = points.length,
            i, polyline;
        if (pointsLen == 0) {
            return;
        }
        // 创建标注对象并添加到地图   
        for (i = 0; i < pointsLen; i++) {
            linePoints.push(new BMap.Point(points[i].lng, points[i].lat));
        }

        polyline = new BMap.Polyline(linePoints, {
            strokeColor: "green",
            strokeWeight: 2,
            strokeOpacity: 1,
        }); //创建折线
        map.addOverlay(polyline); //增加折线
    }

    //添加虚线
    function addDashedLine(points) {
        var linePoints = [],
            pointsLen = points.length,
            i, polyline;
        if (pointsLen == 0) {
            return;
        }
        // 创建标注对象并添加到地图   
        for (i = 0; i < pointsLen; i++) {
            linePoints.push(new BMap.Point(points[i].lng, points[i].lat));
        }

        polyline = new BMap.Polyline(linePoints, {
            strokeColor: "red",
            strokeWeight: 2,
            strokeOpacity: 0.8,
            strokeStyle: 'dashed'
        }); //创建折线
        map.addOverlay(polyline); //增加折线
    }

    //新的点，加入到轨迹中。
    function dynamicLine() {
        //var lng = 100+getRandom(40);
        //var lat = 35+getRandom(30);
        lng += .1;
        lat += .3;
        var id = getRandom(1000);
        var point = {
            "lng": lng,
            "lat": lat,
            "status": 1,
            "id": id
        }
        var makerPoints = [];
        //var newLinePoints = [];
        //var len;
        makerPoints.push(point);
        console.log(makerPoints);
        points.push(point);
        //bPoints.push(new BMap.Point(lng, lat));
        //len = points.length;
        //newLinePoints = points.slice(len - 2, len); //最后两个点用来画线。
        newPointsDashed = pointsDashed.slice(points.length - 1, pointsDashed.length);
        //console.log(points, newPointsDashed)

        map.clearOverlays(); //清除折线
        var angle = 0; //飞机角度
        if (i > 0) {
            angle = findRotation(points[i - 1], points[i]);
        }
        i++;
        addMarker(makerPoints, angle); //增加对应该的轨迹点
        addDashedLine(newPointsDashed); //画虚线
        addLine(points); //增加轨迹线
        //setZoom(bPoints);
        setTimeout(dynamicLine, 1000);
    }

    //根据点信息实时更新地图显示范围，让轨迹完整显示。设置新的中心点和显示级别. 
    //更新。设置不是每次增加点都重新设置显示范围。因为有可能会想放大了看。
    // function setZoom(bPoints) {
    //     var view = map.getViewport(eval(bPoints));
    //     console.log(view);
    //     if (map.oldView != JSON.stringify(view)) {
    //         var mapZoom = view.zoom;
    //         var centerPoint = view.center;
    //         map.centerAndZoom(centerPoint, mapZoom);
    //         map.oldView = JSON.stringify(view);
    //     }
    // }

    //数据准备,
    var i = 0; //上一个点
    var lng = 100;
    var lat = 35;
    var lng02 = lng;
    var lat02 = lat;
    var points = []; //原始点信息数组
    var pointsDashed = []; //计划，点信息数组
    var newPointsDashed = []; //计划，点信息数组
    //var bPoints = []; //百度化坐标数组。用于更新显示范围。
    for (var k = 0; k < 100; k++) {
        var id = 400 + k;
        lng02 += .1;
        lat02 += .2;
        pointsDashed.push({
            "lng": lng02,
            "lat": lat02,
            "status": 2,
            "id": id
        });
    }
    pointsDashed.push({
        "lng": 121,
        "lat": 50,
        "status": 2,
        "id": 9009
    });
    //console.log(pointsDashed);
    newPointsDashed = pointsDashed.slice(points.length, pointsDashed.length);
    //地图操作开始
    var map = new BMap.Map("container");

    map.centerAndZoom(new BMap.Point(103.388611, 35.563611), 5); //初始显示中国。
    map.enableScrollWheelZoom(); //滚轮放大缩小

    //画虚线
    addDashedLine(newPointsDashed);
    //setTimeout(dynamicLine, 2000); //动态生成新的点。
    dynamicLine(); //动态生成新的点。
    </script>
</body>

</html>
